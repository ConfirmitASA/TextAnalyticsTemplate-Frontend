<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>aggregatedTable/sortTable.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AggregatedTable.html">AggregatedTable</a><ul class='methods'><li data-type='method'><a href="AggregatedTable.html#.debounce">debounce</a></li><li data-type='method'><a href="AggregatedTable.html#.spliceLevel">spliceLevel</a></li><li data-type='method'><a href="AggregatedTable.html#addSearchBox">addSearchBox</a></li><li data-type='method'><a href="AggregatedTable.html#addToggleButton">addToggleButton</a></li><li data-type='method'><a href="AggregatedTable.html#clearSearch">clearSearch</a></li><li data-type='method'><a href="AggregatedTable.html#focusFollows">focusFollows</a></li><li data-type='method'><a href="AggregatedTable.html#onSort">onSort</a></li><li data-type='method'><a href="AggregatedTable.html#reorderSorted">reorderSorted</a></li><li data-type='method'><a href="AggregatedTable.html#scrollTo">scrollTo</a></li><li data-type='method'><a href="AggregatedTable.html#scrollToElement">scrollToElement</a></li><li data-type='method'><a href="AggregatedTable.html#search">search</a></li><li data-type='method'><a href="AggregatedTable.html#updateSearchTarget">updateSearchTarget</a></li></ul></li><li><a href="FixedHeader.html">FixedHeader</a><ul class='methods'><li data-type='method'><a href="FixedHeader.html#cloneHeader">cloneHeader</a></li><li data-type='method'><a href="FixedHeader.html#init">init</a></li><li data-type='method'><a href="FixedHeader.html#resizeFixed">resizeFixed</a></li><li data-type='method'><a href="FixedHeader.html#resizeThrottler">resizeThrottler</a></li><li data-type='method'><a href="FixedHeader.html#scrollFixed">scrollFixed</a></li><li data-type='method'><a href="FixedHeader.html#wrapTable">wrapTable</a></li></ul></li><li><a href="HierarchyTable.html">HierarchyTable</a><ul class='methods'><li data-type='method'><a href="HierarchyTable.html#._isNumber">_isNumber</a></li><li data-type='method'><a href="HierarchyTable.html#.addCollapseButton">addCollapseButton</a></li><li data-type='method'><a href="HierarchyTable.html#.clearLink">clearLink</a></li><li data-type='method'><a href="HierarchyTable.html#init">init</a></li><li data-type='method'><a href="HierarchyTable.html#parseHierarchy">parseHierarchy</a></li><li data-type='method'><a href="HierarchyTable.html#reorderRows">reorderRows</a></li><li data-type='method'><a href="HierarchyTable.html#searchRowheaders">searchRowheaders</a></li><li data-type='method'><a href="HierarchyTable.html#setUpBlocks">setUpBlocks</a></li><li data-type='method'><a href="HierarchyTable.html#setupMeta">setupMeta</a></li><li data-type='method'><a href="HierarchyTable.html#setupSearch">setupSearch</a></li><li data-type='method'><a href="HierarchyTable.html#toggleHiddenRows">toggleHiddenRows</a></li><li data-type='method'><a href="HierarchyTable.html#uncollapseParents">uncollapseParents</a></li><li data-type='method'><a href="HierarchyTable.html#updateCategoryLabel">updateCategoryLabel</a></li></ul></li><li><a href="Highlight.html">Highlight</a><ul class='methods'><li data-type='method'><a href="Highlight.html#apply">apply</a></li><li data-type='method'><a href="Highlight.html#getRegex">getRegex</a></li><li data-type='method'><a href="Highlight.html#remove">remove</a></li><li data-type='method'><a href="Highlight.html#setMatchType">setMatchType</a></li><li data-type='method'><a href="Highlight.html#setRegex">setRegex</a></li></ul></li><li><a href="LazyHierarchyFetch.html">LazyHierarchyFetch</a><ul class='methods'><li data-type='method'><a href="LazyHierarchyFetch.html#.rowIsLoading">rowIsLoading</a></li><li data-type='method'><a href="LazyHierarchyFetch.html#.stripRowsFromResponseTable">stripRowsFromResponseTable</a></li><li data-type='method'><a href="LazyHierarchyFetch.html#fetchChildHierarchy">fetchChildHierarchy</a></li><li data-type='method'><a href="LazyHierarchyFetch.html#fetchChildRows">fetchChildRows</a></li><li data-type='method'><a href="LazyHierarchyFetch.html#fixDrilldownLink">fixDrilldownLink</a></li><li data-type='method'><a href="LazyHierarchyFetch.html#parseHierarchy">parseHierarchy</a></li><li data-type='method'><a href="LazyHierarchyFetch.html#parseHierarchyRow">parseHierarchyRow</a></li><li data-type='method'><a href="LazyHierarchyFetch.html#setUpBlocks">setUpBlocks</a></li><li data-type='method'><a href="LazyHierarchyFetch.html#setUpExpandListener">setUpExpandListener</a></li><li data-type='method'><a href="LazyHierarchyFetch.html#triggerDrilldown">triggerDrilldown</a></li></ul></li><li><a href="ReportalBase.html">ReportalBase</a><ul class='methods'><li data-type='method'><a href="ReportalBase.html#.getQueryVariable">getQueryVariable</a></li><li data-type='method'><a href="ReportalBase.html#.newEvent">newEvent</a></li><li data-type='method'><a href="ReportalBase.html#promiseRequest">promiseRequest</a></li></ul></li><li><a href="SortTable.html">SortTable</a><ul class='methods'><li data-type='method'><a href="SortTable.html#.sorter">sorter</a></li><li data-type='method'><a href="SortTable.html#setupColumns">setupColumns</a></li><li data-type='method'><a href="SortTable.html#setupSortOrder">setupSortOrder</a></li><li data-type='method'><a href="SortTable.html#sort">sort</a></li><li data-type='method'><a href="SortTable.html#updateSorting">updateSorting</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#mixin">mixin</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">aggregatedTable/sortTable.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Created by IvanP on 26.07.2016.
 */

class SortTable{
  /**
   * Makes a table sortable, gives API for sorting. It sorts `data` array, but doesn't move rows in the `source` table, because of differences in implementation
   * @param {Boolean} enabled=false - enables sorting on a header of a table
   * @param {HTMLTableElement} source - source table sorting will be applied to
   * @param {HTMLTableElement} [auxHeader] - the floating header if any, will reflect and trigger sorting on header when scrolled.
   * @param {Number} [defaultHeaderRow=-1] - index of the row in `thead` (incremented from 0) that will have sorting enabled for columns. If `-1` then last row.
   * @param {Array} [columns] - Array of column indices (incremented from 0) that will have sorting enabled. If not specified, all columns will be sortable. Optionally `excludedColumns` can be specified instead as a shorthand to pass only indices of columns to be excluded from sorting, assumning that others will be made sortable
   * @param {Array} [excludedColumns] - Array of column indices (incremented from 0) that will be excluded from sorting. Can be used as a shorthand instead of `columns`.
   * @param {Object} [defaultSorting] - an array of objects that specify default sorting
   * @param {Number} defaultSorting.column - column index
   * @param {String} defaultSorting.direction - sort direction (`asc`|`desc`)
   * @param {Array} data - data with information for rows to be sorted
   * */
  constructor({enabled=false,source,auxHeader,defaultHeaderRow=-1,columns,excludedColumns,defaultSorting=[],data=[]}={}){
    let event = document.createEvent('Event');
    event.initEvent('reportal-table-sort', true, true);
    this._sortEvent = event;

    this.enabled=enabled;
    this.source=source;
    this.data = data;
    // calculate default header row
    let headerRows = source.querySelector('thead').children,
      auxHeaderRows = auxHeader?auxHeader.querySelector('thead').children:null,
      headerRowIndex = defaultHeaderRow==-1?headerRows.length+defaultHeaderRow:defaultHeaderRow;
    this.defaultHeaderRow={index:headerRowIndex, row:headerRows.item(headerRowIndex), auxRow:auxHeaderRows?auxHeaderRows.item(headerRowIndex):null};

    this.sortOrder = [];//necessary for proper initialization of `columns`
    this.columns=this.setupColumns(columns, excludedColumns);

    // setup sort order and do initial default sorting
    this.sortOrder = this.setupSortOrder(defaultSorting);

    this.sort(); //initial sorting if any
  }

  /**
   * Creates a `sortOrder` array with utility functions `add`,`remove`,`replace`
   * @param {Object} defaultSorting - an array of objects that specify default sorting
   * @param {Number} defaultSorting.column - column index
   * @param {String} defaultSorting.direction - sort direction (`asc`|`desc`)
   * @return {Array}
   * */
  setupSortOrder(defaultSorting){
    var sortOrder = [];
    var self = this;
    /**
     * Replaces all items in sort order
     * @param {{column:Number,direction:String}} obj - object describing sorting
     * @param {Number} obj.column - column index
     * @param {String} obj.direction - sort direction (`asc`|`desc`)
     * */
    sortOrder.replace = function(obj){
      if(this.length>0){
        this.forEach((item,index)=>{
          this.remove(index,item.column);
      });
      }
      this.add(obj);
      self.sort();
    };

    /**
     * Adds another column to be sorted
     * @param {{column:Number,direction:String}} obj - object describing sorting
     * @param {Number} obj.column - column index
     * @param {String} obj.direction - sort direction (`asc`|`desc`)
     * */
    sortOrder.add = function(obj){
      self.columns[obj.column].cell.classList.add('sorted',obj.direction);
      if(self.columns[obj.column].auxCell)self.columns[obj.column].auxCell.classList.add('sorted',obj.direction);
      sortOrder.push(obj);
    };

    /**
     * Removes a column from `sortOrder`
     * @param {Number} index - index of item in `sortOrder` array to be removed
     * @param {Number} column - column index as reference to the item to be removed.
     * */
    sortOrder.remove = function(index,column){
      self.columns[column].cell.classList.remove('sorted','asc','desc');
      if(self.columns[column].auxCell)self.columns[column].auxCell.classList.remove('sorted','asc','desc');
      this.splice(index,1);
    };

    if(defaultSorting.length>0){
      defaultSorting.forEach(item=>sortOrder.add(item));
    }

    return sortOrder;
  }

  /**
   * Creates an array of objects corresponding to the cells of `defaultHeaderRow`, that contain `sortable` property, denoting the column is sortable, `index` of the column and reference to the `cell`. Adds `.sortable` to a sortable cell
   * @return {{sortable:Boolean, index:Number, cell: HTMLTableCellElement}} - an array of objects that have this structure
   * */
  setupColumns(columns,excluded){
    var headerRows = this.source.querySelector('thead').children;
    if(headerRows.length==0){console.warn(`Sorting is impossible because table#${source.id} doesn't have headers`);return;}
    let headerColumns = [].slice.call(this.defaultHeaderRow.row.children);
    if(headerRows.length>1 &amp;&amp; headerRows.item(0).children.item(0).rowSpan>1){ // if there is more than one row in header and if the first header has a cell with rowspan, add it to the array
      headerColumns.unshift(headerRows.item(0));
    }
    if(this.defaultHeaderRow.auxRow){
      var auxHeaderRows = this.defaultHeaderRow.auxRow.parentNode.children;
      var auxHeaderColumns = [].slice.call(this.defaultHeaderRow.auxRow.children);
      if(headerRows.length>1 &amp;&amp; headerRows.item(0).children.item(0).rowSpan>1){
        auxHeaderColumns.unshift(auxHeaderRows.item(0));
      }
    }
    var realColumnIndex=0;
    return headerColumns.map((cell,index)=>{
        let sortable = (!(columns &amp;&amp; columns.indexOf(cell.cellIndex)==-1) || (excluded &amp;&amp; excluded.indexOf(index)==-1)); // is in columns and not in excluded,
    if(sortable){
      cell.addEventListener('click',(el)=>{
        if(el.target.localName =='td'||el.target.localName =='th'){this.updateSorting(el.target);} //we want to capture click on the cell and not buttons in it
    });
      cell.classList.add('sortable');
      if(auxHeaderColumns){
        var auxCell = auxHeaderColumns[index];
        auxCell.addEventListener('click',(el)=>{
          if(el.target.localName =='td'||el.target.localName =='th'){this.updateSorting(el.target);} //we want to capture click on the cell and not buttons in it
      });
        auxCell.classList.add('sortable');
      }

    }
    let _sorted = null,
      self = this;
    var obj = {
      sortable:sortable,
      get sorted(){return _sorted},
      set sorted(val){
        _sorted = val;
        if(val){
          this.cell.classList.add('sorted');
          this.auxCell?this.auxCell.classList.add('sorted'):null;
        } else {
          this.cell.classList.remove('sorted','asc','desc');
          this.auxCell?this.auxCell.classList.remove('sorted','asc','desc'):null;
        }
      },
      index: realColumnIndex,
      cell: cell,
      auxCell: auxCell
    };
    if(cell.colSpan>1){
      realColumnIndex= realColumnIndex + cell.colSpan;
    } else {realColumnIndex++}
    return obj;
  });
  }

  /**
   * Performs sorting. Can sort two columns if `sortOrder` has two items, the first of which has priority.
   * @return {Event} - `reportal-table-sort` event
   * */
  sort(){
    if(this.sortOrder &amp;&amp; this.sortOrder.length>0){
      this.data.forEach((block,index,array)=>{
      block.sort((a, b)=>{ // sort rows
        if(this.sortOrder.length>1){
        return this.constructor.sorter(a[this.columns[this.sortOrder[0].column].index],b[this.columns[this.sortOrder[0].column].index], this.sortOrder[0].direction === 'desc' ? -1 : 1) || this.constructor.sorter(a[this.columns[this.sortOrder[1].column].index],b[this.columns[this.sortOrder[1].column].index], this.sortOrder[1].direction === 'desc' ? -1 : 1)
      } else {
        return this.constructor.sorter(a[this.columns[this.sortOrder[0].column].index],b[this.columns[this.sortOrder[0].column].index], this.sortOrder[0].direction === 'desc' ? -1 : 1);
      }
    });
    });
      this.columns[this.sortOrder[0].column].cell.dispatchEvent(this._sortEvent);
    }
  }

  /**
   * Updates `sortOrder` with the clicked cell
   * @param {HTMLTableCellElement} cell - the cell that was clicked
   * */
  updateSorting(cell){
    if(!cell.classList.contains('sorted')){ // this column is not sorted, there might be others that are.
      this.sortOrder.replace({column:cell.cellIndex, direction: 'asc'});
    } else { //swaps sorting from asc to desc
      this.sortOrder.replace({column:cell.cellIndex, direction: cell.classList.contains('asc')?'desc':'asc'});
    }
  }

  /**
   * Function that performs case insensitive sorting in the array. It can distinguish between numbers, numbers as strings, HTML and plain strings
   * */
  static sorter(a,b,lesser){
    //let x = a[idx],y = b[idx];
    let regex = /[&lt;>]/g;
    if(regex.test(a) || regex.test(b)){ // if we need to sort elements that have HTML like links
      let tempEl1 = document.createElement('span'); tempEl1.innerHTML = a;
      a=tempEl1.textContent.trim();
      let tempEl2 = document.createElement('span'); tempEl2.innerHTML = b;
      b=tempEl2.textContent.trim();
    }
    if(!isNaN(a) &amp;&amp; !isNaN(b)){//they might be numbers or null
      if(a===null){return 1} else if(b===null){return -1}
      return a &lt;  b ? lesser :  a >  b ? -lesser : 0;
    }
    else if(!isNaN(parseFloat(a)) &amp;&amp; !isNaN(parseFloat(b))){ // they might be number strings
      return parseFloat(a) &lt;  parseFloat(b) ? lesser :  parseFloat(a) >  parseFloat(b) ? -lesser : 0;
    } else { //they might be simple strings
      return a.toLowerCase() &lt; b.toLowerCase() ? lesser : a.toLowerCase() > b.toLowerCase() ? -lesser : 0;
    }
  }

}

export default SortTable
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Wed Aug 17 2016 18:21:07 GMT+0300 (Russia TZ 2 Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
